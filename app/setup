#!/bin/bash
set -e

TARGET_USER="$1"

if [[ "$TARGET_USER" = "" ]]; then
	echo "Usage: ./setup <TARGET USER>"
	exit 1
fi

if [[ "`id -u`" != 0 ]]; then
	echo "This script must be run as root."
	exit 1
fi

function apt_get_install()
{
	apt-get install -q -y --force-yes --no-install-recommends "$@"
}

export DEBIAN_FRONTEND=noninteractive
SELFDIR=`dirname "$0"`
set -x
cd "$SELFDIR"

# Add APT sources.
if ! [[ -e /etc/apt/sources.list.d/docker.list ]]; then
	if ! [[ -e /usr/bin/wget ]]; then
		apt-get update
		apt_get_install wget
	fi
	wget -q -O - https://get.docker.io/gpg | apt-key add -
	echo deb http://get.docker.io/ubuntu docker main > /etc/apt/sources.list.d/docker.list
	apt-get update
fi

# Install software.
apt_get_install lxc-docker cgroup-lite git postfix inotify-tools libpq-dev postgresql

# Setup Docker.
usermod -a -G docker $TARGET_USER

# Setup PostgreSQL service.
update-rc.d -f postgresql remove
if ! [[ -e /etc/service/postgresql/run ]]; then
	service postgresql stop
fi
mkdir -p /etc/service/postgresql
cp resources/run_postgresql /etc/service/postgresql/run
while ! [[ -e /etc/service/postgresql/supervise/ok ]]; do
	sleep 1
done
sv start /etc/service/postgresql
sleep 1

# Setup PostgreSQL authentication.
if ! grep -q $TARGET_USER /etc/postgresql/9.1/main/pg_ident.conf; then
	echo "appa $TARGET_USER $TARGET_USER" >> /etc/postgresql/9.1/main/pg_ident.conf
fi
if ! grep -q $TARGET_USER /etc/postgresql/9.1/main/pg_hba.conf; then
	echo "local all $TARGET_USER peer map=appa" >> /etc/postgresql/9.1/main/pg_hba.conf
fi
if ! (sudo -u postgres psql <<<"select rolname from pg_roles" | grep -q $TARGET_USER); then
	sudo -u postgres -H createuser -s -r $TARGET_USER
fi

# Setup PostgreSQL databases.
databases=`sudo -u postgres -H psql <<<"select datname from pg_database where datistemplate = false"`
if [[ $TARGET_USER = vagrant ]]; then
	if ! [[ "$databases" =~ appa_dev ]]; then
		sudo -u postgres -H createdb appa_dev
	fi
	if ! [[ "$databases" =~ appa_test ]]; then
		sudo -u postgres -H createdb appa_test
	fi
fi
if ! [[ "$databases" =~ appa_prod ]]; then
	sudo -u postgres -H createdb appa_prod
fi

# Install gem bundle.
mkdir -p /appa_bundle
chown $TARGET_USER: /appa_bundle
sudo -u $TARGET_USER -H bundle install --path /appa_bundle
cd webui
sudo -u $TARGET_USER -H bundle install --path /appa_bundle
